---
title: "kafka - producer"
date: 2025-07-23
author: cimaStone
category: "æŠ€æœ¯æž¶æž„/kafka"
tags: 
  - producer
  - kafka
---

# kafka - producer

## ðŸŽ¯ èƒŒæ™¯
   è¯¥ç¯‡æ–‡ç« ä¸»è¦è®²è¿°çš„æ˜¯producerå‘é€æ¶ˆæ¯ç»™åˆ°broker â€”â€”> brokerçš„å®Œæ•´æµç¨‹ï¼›é‡Œé¢å¯èƒ½ä¹Ÿæ¶‰åŠåˆ°kafa serverçš„ç›¸å…³è®¾è®¡

---

## ä¸€ã€Kafkaçš„æ ¸å¿ƒæ¦‚å¿µ

- Producerï¼ˆç”Ÿäº§è€…ï¼‰ï¼šå‘é€æ¶ˆæ¯åˆ°Kafkaé›†ç¾¤çš„å®¢æˆ·ç«¯åº”ç”¨ã€‚
- Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰ï¼šä»ŽKafkaé›†ç¾¤æ‹‰å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ã€‚
- Brokerï¼šKafkaé›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè´Ÿè´£æ¶ˆæ¯çš„æŽ¥æ”¶ã€å­˜å‚¨å’Œåˆ†å‘ã€‚
- Topicï¼ˆä¸»é¢˜ï¼‰ï¼šæ¶ˆæ¯çš„åˆ†ç±»/ç±»åˆ«ï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°ç‰¹å®šçš„topicï¼Œæ¶ˆè´¹è€…ä»Žtopicä¸­è¯»å–æ¶ˆæ¯ã€‚
- Partitionï¼ˆåˆ†åŒºï¼‰ï¼šæ¯ä¸ªtopicå¯ä»¥è¢«åˆ†æˆå¤šä¸ªpartitionï¼Œæå‡å¹¶å‘å’Œå®¹é”™èƒ½åŠ›ã€‚
- Offsetï¼šæ¶ˆæ¯åœ¨partitionä¸­çš„å”¯ä¸€ç¼–å·ï¼Œæ¶ˆè´¹è€…æ ¹æ®offsetè¯»å–æ¶ˆæ¯ã€‚

Kafkaçš„å…¸åž‹åº”ç”¨åœºæ™¯ï¼š

- æ—¥å¿—æ”¶é›†ä¸Žåˆ†æž
- å®žæ—¶ç›‘æŽ§å’Œå‘Šè­¦
- æµå¼æ•°æ®å¤„ç†
- æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§£è€¦å¾®æœåŠ¡ï¼‰

Kafkaçš„åŸºæœ¬å·¥ä½œæµç¨‹ï¼š

- Producerå°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®štopicã€‚
- BrokeræŽ¥æ”¶æ¶ˆæ¯å¹¶å­˜å‚¨åœ¨topicçš„partitionä¸­ã€‚
- Consumerè®¢é˜…topicï¼Œä»Žå¯¹åº”çš„partitionä¸­æ‹‰å–æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚
  
Kafkaçš„ä¼˜åŠ¿ï¼š

- é«˜åžåé‡ï¼šæ”¯æŒå¤§è§„æ¨¡æ¶ˆæ¯å¤„ç†ã€‚
- å¯æ‰©å±•æ€§ï¼šæ”¯æŒé›†ç¾¤æ‰©å±•ã€‚
- æŒä¹…åŒ–ï¼šæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæ”¯æŒå®¹é”™ã€‚
- åˆ†å¸ƒå¼ï¼šå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€‚

åœ¨ KRaftï¼ˆKafka Raft Metadata modeï¼‰ä¸‹ï¼ŒKafka ä¸å†ä¾èµ– ZooKeeperï¼Œæ‰€æœ‰å…ƒæ•°æ®ç”± Kafka é›†ç¾¤è‡ªèº«ç®¡ç†ã€‚KRaft é‡‡ç”¨äº† Raft å…±è¯†åè®®ï¼Œç¡®ä¿å…ƒæ•°æ®çš„ä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§ã€‚

### 1.1 å…ƒæ•°æ®çš„å†…å®¹
Kafka çš„å…ƒæ•°æ®åŒ…æ‹¬ä½†ä¸é™äºŽï¼š
- é›†ç¾¤é…ç½®ä¿¡æ¯ï¼ˆCluster configï¼‰
- Topic åˆ—è¡¨åŠå…¶åˆ†åŒºï¼ˆTopic & Partitionï¼‰
- åˆ†åŒºå‰¯æœ¬åˆ†é…ï¼ˆReplica assignmentï¼‰
- æŽ§åˆ¶å™¨é€‰ä¸¾çŠ¶æ€ï¼ˆController electionï¼‰
- ACLï¼ˆè®¿é—®æŽ§åˆ¶åˆ—è¡¨ï¼‰
- Producer/Consumer çš„åè°ƒçŠ¶æ€
- äº‹åŠ¡çŠ¶æ€

æ‰€æœ‰è¿™äº›ä¿¡æ¯éƒ½å†™å…¥ KRaft çš„å…ƒæ•°æ®æ—¥å¿—ï¼ˆmetadata logï¼‰ï¼Œç”±é›†ç¾¤å†…çš„ controller quorumï¼ˆæŽ§åˆ¶å™¨æ³•å®šèŠ‚ç‚¹ï¼‰ç®¡ç†ã€‚

---

### 2. ä¸»è¦è§’è‰²

#### 2.1 Controllerï¼ˆæŽ§åˆ¶å™¨ï¼‰
- å®šä¹‰ï¼šåœ¨ KRaft æ¨¡å¼ä¸‹ï¼ŒController ä¸å†æ˜¯å•èŠ‚ç‚¹ï¼Œè€Œæ˜¯ä»¥ Raft åè®®ç»„æˆçš„ä¸€ä¸ªæŽ§åˆ¶å™¨ quorumï¼ˆé€šå¸¸ä¸º3ã€5æˆ–7ä¸ªèŠ‚ç‚¹ï¼‰ã€‚
- èŒè´£ï¼š
  - è´Ÿè´£æ‰€æœ‰å…ƒæ•°æ®çš„è¯»å†™å’Œä¸€è‡´æ€§ç»´æŠ¤ï¼ˆå¦‚ Topic åˆ›å»ºã€åˆ†åŒºæ‰©å®¹ã€å‰¯æœ¬åˆ†é…ï¼‰ã€‚
  - è´Ÿè´£ leader é€‰ä¸¾ã€é›†ç¾¤çŠ¶æ€ç›‘æŽ§ã€èŠ‚ç‚¹ä¸Šä¸‹çº¿æ£€æµ‹ã€‚
  - å”¯ä¸€èƒ½å†™å…¥å’Œæäº¤å…ƒæ•°æ®å˜æ›´çš„æ˜¯ Raft quorum çš„ Leaderã€‚
  - é€šè¿‡ Raft æ—¥å¿—å¤åˆ¶ä¿è¯æ‰€æœ‰ controller èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´ã€‚
 
#### 2.2 Brokerï¼ˆä»£ç†/æœåŠ¡ç«¯èŠ‚ç‚¹ï¼‰
- å®šä¹‰ï¼šBroker æ˜¯å®žé™…å­˜å‚¨å’Œè½¬å‘æ¶ˆæ¯çš„èŠ‚ç‚¹ã€‚
- èŒè´£ï¼š
  - å­˜å‚¨ç”¨æˆ·çš„æ¶ˆæ¯æ•°æ®ï¼ˆlog segmentï¼‰ã€‚
  - æ¯ä¸ª broker é€šè¿‡è®¢é˜… controller quorum çš„å…ƒæ•°æ®æ—¥å¿—ï¼Œä¿æŒè‡ªå·±çš„å…ƒæ•°æ®å‰¯æœ¬æœ€æ–°ã€‚
  - ä½œä¸ºåˆ†åŒºå‰¯æœ¬ï¼ˆleader æˆ– followerï¼‰å‚ä¸Žåˆ†åŒºå‰¯æœ¬åŒæ­¥ã€‚
  - Broker èŠ‚ç‚¹å¯ä»¥åŒæ—¶ä½œä¸º controller quorum çš„æˆå‘˜ï¼Œä¹Ÿå¯ä»¥åªä½œä¸ºæ™®é€šæ•°æ®èŠ‚ç‚¹ã€‚

#### 2.3 Partitionï¼ˆåˆ†åŒºï¼‰
- å®šä¹‰ï¼šæ¯ä¸ª topic è¢«åˆ’åˆ†ä¸ºè‹¥å¹² partitionï¼Œpartition æ˜¯ Kafka çš„å¹¶å‘å’Œé«˜å¯ç”¨å•ä½ã€‚
- èŒè´£ï¼š
  - æ¯ä¸ª partition æœ‰å¤šä¸ªå‰¯æœ¬ï¼ˆreplicaï¼‰ï¼Œåˆ†å¸ƒåœ¨ä¸åŒçš„ broker ä¸Šã€‚
  - åˆ†åŒºçš„ leader è´Ÿè´£å¤„ç† client çš„è¯»å†™è¯·æ±‚ï¼Œfollower è´Ÿè´£åŒæ­¥ leader çš„æ•°æ®ã€‚
  - partition çš„åˆ†é…ã€leader/follower çŠ¶æ€ç­‰å…ƒæ•°æ®ç”± controller ç®¡ç†å¹¶å¹¿æ’­ã€‚
 
### 3. å…ƒæ•°æ®çš„å¤„ç†æµç¨‹

#### 3.1 å…ƒæ•°æ®å†™å…¥æµç¨‹ï¼ˆå¦‚åˆ›å»º topicï¼‰
1. å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆå¦‚åˆ›å»º topicï¼‰å‘é€åˆ°ä»»ä¸€ controller quorum æˆå‘˜ã€‚
2. å¦‚æžœè¯¥èŠ‚ç‚¹ä¸æ˜¯ leaderï¼Œä¼šå°†è¯·æ±‚é‡å®šå‘åˆ° quorum leaderã€‚
3. Leader ç”Ÿæˆå…ƒæ•°æ®å˜æ›´æ—¥å¿—ï¼ˆå¦‚æ–° topicã€partitionã€replica assignmentï¼‰ã€‚
4. å…ƒæ•°æ®æ—¥å¿—é€šè¿‡ Raft å¤åˆ¶åˆ°æ‰€æœ‰ controller æˆå‘˜ï¼ˆå¤§å¤šæ•°æäº¤åŽç”Ÿæ•ˆï¼‰ã€‚
5. å¿—ï¼Œæ›´æ–°æœ¬åœ°å…ƒæ•°æ®ç¼“å­˜ã€‚
6. Broker æ ¹æ®æœ€æ–°å…ƒæ•°æ®è¿›è¡Œåˆ†åŒºåˆ›å»ºã€åˆ†é…å‰¯æœ¬ã€è°ƒæ•´ leader/follower ç­‰æ“ä½œã€‚

#### 3.2 å…ƒæ•°æ®è¯»å–æµç¨‹

- ä»»ä½• broker éƒ½å¯ä»¥ä¸º client æä¾›å…ƒæ•°æ®æŸ¥è¯¢æœåŠ¡ï¼ˆå¦‚ topic/partition åˆ—è¡¨ï¼‰ã€‚
- Broker æœ¬åœ°ç¼“å­˜çš„å…ƒæ•°æ®é€šè¿‡è®¢é˜… controller quorum çš„å…ƒæ•°æ®æ—¥å¿—å®šæœŸæ›´æ–°ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚

### 4. Controllerã€Brokerã€Partition çš„äº’åŠ¨

- Controller quorum ä½œä¸ºå”¯ä¸€çš„å…ƒæ•°æ®â€œæƒå¨â€ï¼Œæ‰€æœ‰å˜æ›´éƒ½å¿…é¡»é€šè¿‡å®ƒä»¬æäº¤ã€‚
- Broker ä»…ä½œä¸ºå…ƒæ•°æ®çš„â€œæ¶ˆè´¹è€…â€ä¸Žâ€œæ‰§è¡Œè€…â€ï¼Œä¸ä¼šä¸»åŠ¨ä¿®æ”¹å…ƒæ•°æ®ï¼Œåªèƒ½æ ¹æ® controller çš„æŒ‡ä»¤æ“ä½œå®žé™…åˆ†åŒºæˆ–å‰¯æœ¬ã€‚
- Partition çš„ leader/follower çŠ¶æ€ã€åˆ†å¸ƒã€ISRï¼ˆin-sync replicasï¼‰ç­‰éƒ½ç”± controller ç»Ÿä¸€è°ƒåº¦å’Œç»´æŠ¤ã€‚


## äºŒã€åˆ›å»ºtopicå…¨æµç¨‹

### 1. åˆ›å»º Topic è¯·æ±‚çš„æµè½¬

#### 1.1 Producer è¯·æ±‚åˆ° Controller éž Leader èŠ‚ç‚¹

- Producer æˆ–ç®¡ç†å‘˜å®¢æˆ·ç«¯ï¼ˆå¦‚ kafka-topics.shï¼‰å‘ä»»æ„ Controller èŠ‚ç‚¹å‘èµ·â€œåˆ›å»º topicâ€è¯·æ±‚ã€‚
- è¿™ä¸ª broker ä¼šæ£€æµ‹åˆ°è‡ªå·±ä¸æ˜¯å½“å‰çš„ Controller Leaderï¼Œç›´æŽ¥è¿”å›ž NOT_CONTROLLER é”™è¯¯ç»™å®¢æˆ·ç«¯ã€‚
- å®¢æˆ·ç«¯ï¼ˆå¦‚ kafka-topics.shã€AdminClientï¼‰æ”¶åˆ°è¿™ä¸ªé”™è¯¯åŽï¼Œä¼šè‡ªåŠ¨åˆ·æ–°å…ƒæ•°æ®ã€å‘çŽ°æ–°çš„ Controller Leaderï¼Œç„¶åŽåŽç»­çš„ç›¸å…³è¯·æ±‚ä¼šç›´æŽ¥å‘ç»™æ–°çš„ Controller Leaderã€‚
  
#### 1.2 Controller Leader å¤„ç†æµç¨‹
1. **ç”Ÿæˆå…ƒæ•°æ®å˜æ›´è®°å½•**
Controller leader å°†â€œåˆ›å»º topicâ€æ“ä½œå°è£…ä¸ºä¸€æ¡å…ƒæ•°æ®æ—¥å¿—ï¼ˆrecordï¼‰ï¼ŒåŒ…æ‹¬ topic åã€åˆ†åŒºæ•°ã€å‰¯æœ¬æ•°ç­‰ã€‚

2. **Raft æ—¥å¿—å¤åˆ¶**
  - è¿™æ¡æ—¥å¿—è¢«è¿½åŠ åˆ° controller quorum çš„æœ¬åœ° Raft æ—¥å¿—ä¸­ã€‚
  - leader é€šè¿‡ Raft åè®®æŠŠæ—¥å¿—åŒæ­¥åˆ°å…¶ä»– controller èŠ‚ç‚¹ã€‚
  - ä¸€æ—¦å¤§å¤šæ•°èŠ‚ç‚¹æŒä¹…åŒ–è¯¥ entryï¼Œleader å°†å…¶ commitï¼ˆæŽ¨è¿› commitIndexï¼‰ï¼Œå¹¶åº”ç”¨åˆ°æœ¬åœ°å…ƒæ•°æ®å­˜å‚¨ã€‚
    
3. **è¿”å›ž Producer**
leader commit åŽï¼Œå³å¯å‘ producer/client è¿”å›žâ€œåˆ›å»ºæˆåŠŸâ€å“åº”ã€‚

### 2. Partition åˆ†é…å’Œå‰¯æœ¬åˆ†å¸ƒ

#### 2.1 åˆ†åŒºåˆ†é…ç­–ç•¥

- Controller leader æ ¹æ® topic çš„åˆ†åŒºæ•°å’Œå‰¯æœ¬å› å­ï¼Œä¸ºæ¯ä¸ª partition æŒ‘é€‰ä¸€ç»„ broker ä½œä¸ºå‰¯æœ¬èŠ‚ç‚¹ã€‚
- é»˜è®¤é‡‡ç”¨â€œè½®è¯¢+å‡è¡¡â€çš„åˆ†å¸ƒå¼åˆ†é…ç®—æ³•ï¼ˆRound Robinã€Rack Awarenessç­‰ï¼‰ï¼Œé¿å…çƒ­ç‚¹å’Œå•ç‚¹ã€‚
  
ä¾‹å¦‚ï¼š

- åˆ›å»º topic fooï¼Œ3 åˆ†åŒºï¼Œ2 å‰¯æœ¬ï¼Œé›†ç¾¤æœ‰ broker 1/2/3ã€‚
- å¯èƒ½çš„åˆ†é…ç»“æžœï¼š
  - partition 0: broker 1, broker 2
  - partition 1: broker 2, broker 3
  - partition 2: broker 3, broker 1
    
#### 2.2 Partition Leader é€‰æ‹©

- é»˜è®¤æ¯ä¸ª partition çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬èŠ‚ç‚¹ä¸º leaderã€‚
- controller leader åœ¨åˆ†é…æ—¶æŒ‡å®šæ¯ä¸ª partition çš„ leaderï¼ˆé€šå¸¸æ˜¯è¯¥ partition çš„å‰¯æœ¬åˆ—è¡¨ç¬¬ä¸€ä¸ª brokerï¼‰ã€‚

### 3. Partition å‰¯æœ¬åŒæ­¥æœºåˆ¶

#### 3.1 å…ƒæ•°æ®ä¸‹å‘

- æ‰€æœ‰ broker ç›‘å¬ controller quorum çš„å…ƒæ•°æ®æ—¥å¿—æ›´æ–°ã€‚
- ä¸€æ—¦ topic åˆ›å»ºå¹¶ commitï¼Œæ‰€æœ‰ broker ä¼šæ”¶åˆ°æœ€æ–°çš„ topic/partition/replica åˆ†é…ä¿¡æ¯ã€‚
  
#### 3.2 å‰¯æœ¬åˆ›å»ºä¸Žåˆ†åŒºæœ¬åœ°åˆå§‹åŒ–

- è¢«æŒ‡å®šä¸ºæŸ partition å‰¯æœ¬çš„ brokerï¼Œä¼šåœ¨æœ¬åœ°åˆå§‹åŒ–å¯¹åº”çš„ log ç›®å½•å’Œå…ƒæ•°æ®ã€‚
- partition leader broker ä¼šæˆä¸ºè¯¥åˆ†åŒºçš„â€œä¸»â€ï¼ŒæŽ¥æ”¶ client çš„ produce/consume è¯·æ±‚ã€‚
  
#### 3.3 å‰¯æœ¬åŒæ­¥æµç¨‹

- partition leader è´Ÿè´£åŒæ­¥æ•°æ®åˆ° follower å‰¯æœ¬ã€‚
- follower é€šè¿‡ Fetch è¯·æ±‚ä»Ž leader æ‹‰å–æ•°æ®ã€‚
- Kafka é€šè¿‡ ISRï¼ˆIn-Sync Replicasï¼‰æœºåˆ¶ï¼Œç›‘æŽ§å„å‰¯æœ¬åŒæ­¥è¿›åº¦ã€‚
- åªæœ‰ ISR å†…çš„å‰¯æœ¬æ‰è¢«è®¤ä¸ºâ€œæ´»è·ƒâ€ï¼Œå†™å…¥æˆåŠŸå¿…é¡»è¢«æ‰€æœ‰ ISR å‰¯æœ¬ç¡®è®¤ã€‚

```bash
Producer -> ä»»æ„ Controller -> Controller Leader
    |        (è½¬å‘/é‡å®šå‘)         |
    |---------------------------->| åˆ›å»º topic request
    |<- è¿”å›žæˆåŠŸå“åº”ï¼ˆcommitåŽï¼‰   |
    |
Controller Leader:
    - ç”Ÿæˆå…ƒæ•°æ®å˜æ›´ï¼ˆåˆ†åŒº/å‰¯æœ¬åˆ†é…ï¼‰
    - Raft æ—¥å¿—å¤åˆ¶å¹¶ commit
    - æœ¬åœ°å…ƒæ•°æ® apply
    - å‘æ‰€æœ‰ broker å¹¿æ’­æœ€æ–° metadata

Broker:
    - æ”¶åˆ°æ–° topic/partition åˆ†é…
    - å„è‡ªåˆå§‹åŒ– partition å‰¯æœ¬
    - leader broker è´Ÿè´£å†™å…¥/åŒæ­¥
    - follower broker é€šè¿‡ Fetch æ‹‰å–
    - ISR æœºåˆ¶ä¿è¯å‰¯æœ¬å¼ºä¸€è‡´
```
