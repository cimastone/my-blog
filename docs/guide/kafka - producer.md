---
title: "kafka - producer"
date: 2025-07-23
author: cimaStone
category: "æŠ€æœ¯æž¶æž„/kafka"
tags: 
  - producer
  - kafka
---

# kafka - producer

## ðŸŽ¯ èƒŒæ™¯
   è¯¥ç¯‡æ–‡ç« ä¸»è¦è®²è¿°çš„æ˜¯producerå‘é€æ¶ˆæ¯ç»™åˆ°broker â€”â€”> brokerçš„å®Œæ•´æµç¨‹ï¼›é‡Œé¢å¯èƒ½ä¹Ÿæ¶‰åŠåˆ°kafa serverçš„ç›¸å…³è®¾è®¡

---

## ä¸€ã€Kafkaçš„æ ¸å¿ƒæ¦‚å¿µ

- Producerï¼ˆç”Ÿäº§è€…ï¼‰ï¼šå‘é€æ¶ˆæ¯åˆ°Kafkaé›†ç¾¤çš„å®¢æˆ·ç«¯åº”ç”¨ã€‚
- Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰ï¼šä»ŽKafkaé›†ç¾¤æ‹‰å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ã€‚
- Brokerï¼šKafkaé›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè´Ÿè´£æ¶ˆæ¯çš„æŽ¥æ”¶ã€å­˜å‚¨å’Œåˆ†å‘ã€‚
- Topicï¼ˆä¸»é¢˜ï¼‰ï¼šæ¶ˆæ¯çš„åˆ†ç±»/ç±»åˆ«ï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°ç‰¹å®šçš„topicï¼Œæ¶ˆè´¹è€…ä»Žtopicä¸­è¯»å–æ¶ˆæ¯ã€‚
- Partitionï¼ˆåˆ†åŒºï¼‰ï¼šæ¯ä¸ªtopicå¯ä»¥è¢«åˆ†æˆå¤šä¸ªpartitionï¼Œæå‡å¹¶å‘å’Œå®¹é”™èƒ½åŠ›ã€‚
- Offsetï¼šæ¶ˆæ¯åœ¨partitionä¸­çš„å”¯ä¸€ç¼–å·ï¼Œæ¶ˆè´¹è€…æ ¹æ®offsetè¯»å–æ¶ˆæ¯ã€‚

Kafkaçš„å…¸åž‹åº”ç”¨åœºæ™¯ï¼š

- æ—¥å¿—æ”¶é›†ä¸Žåˆ†æž
- å®žæ—¶ç›‘æŽ§å’Œå‘Šè­¦
- æµå¼æ•°æ®å¤„ç†
- æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§£è€¦å¾®æœåŠ¡ï¼‰

Kafkaçš„åŸºæœ¬å·¥ä½œæµç¨‹ï¼š

- Producerå°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®štopicã€‚
- BrokeræŽ¥æ”¶æ¶ˆæ¯å¹¶å­˜å‚¨åœ¨topicçš„partitionä¸­ã€‚
- Consumerè®¢é˜…topicï¼Œä»Žå¯¹åº”çš„partitionä¸­æ‹‰å–æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚
  
Kafkaçš„ä¼˜åŠ¿ï¼š

- é«˜åžåé‡ï¼šæ”¯æŒå¤§è§„æ¨¡æ¶ˆæ¯å¤„ç†ã€‚
- å¯æ‰©å±•æ€§ï¼šæ”¯æŒé›†ç¾¤æ‰©å±•ã€‚
- æŒä¹…åŒ–ï¼šæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæ”¯æŒå®¹é”™ã€‚
- åˆ†å¸ƒå¼ï¼šå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€‚

åœ¨ KRaftï¼ˆKafka Raft Metadata modeï¼‰ä¸‹ï¼ŒKafka ä¸å†ä¾èµ– ZooKeeperï¼Œæ‰€æœ‰å…ƒæ•°æ®ç”± Kafka é›†ç¾¤è‡ªèº«ç®¡ç†ã€‚KRaft é‡‡ç”¨äº† Raft å…±è¯†åè®®ï¼Œç¡®ä¿å…ƒæ•°æ®çš„ä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§ã€‚

### 1.1 å…ƒæ•°æ®çš„å†…å®¹
Kafka çš„å…ƒæ•°æ®åŒ…æ‹¬ä½†ä¸é™äºŽï¼š
- é›†ç¾¤é…ç½®ä¿¡æ¯ï¼ˆCluster configï¼‰
- Topic åˆ—è¡¨åŠå…¶åˆ†åŒºï¼ˆTopic & Partitionï¼‰
- åˆ†åŒºå‰¯æœ¬åˆ†é…ï¼ˆReplica assignmentï¼‰
- æŽ§åˆ¶å™¨é€‰ä¸¾çŠ¶æ€ï¼ˆController electionï¼‰
- ACLï¼ˆè®¿é—®æŽ§åˆ¶åˆ—è¡¨ï¼‰
- Producer/Consumer çš„åè°ƒçŠ¶æ€
- äº‹åŠ¡çŠ¶æ€

æ‰€æœ‰è¿™äº›ä¿¡æ¯éƒ½å†™å…¥ KRaft çš„å…ƒæ•°æ®æ—¥å¿—ï¼ˆmetadata logï¼‰ï¼Œç”±é›†ç¾¤å†…çš„ controller quorumï¼ˆæŽ§åˆ¶å™¨æ³•å®šèŠ‚ç‚¹ï¼‰ç®¡ç†ã€‚

---

### 2. ä¸»è¦è§’è‰²

#### 2.1 Controllerï¼ˆæŽ§åˆ¶å™¨ï¼‰
- å®šä¹‰ï¼šåœ¨ KRaft æ¨¡å¼ä¸‹ï¼ŒController ä¸å†æ˜¯å•èŠ‚ç‚¹ï¼Œè€Œæ˜¯ä»¥ Raft åè®®ç»„æˆçš„ä¸€ä¸ªæŽ§åˆ¶å™¨ quorumï¼ˆé€šå¸¸ä¸º3ã€5æˆ–7ä¸ªèŠ‚ç‚¹ï¼‰ã€‚
- èŒè´£ï¼š
  - è´Ÿè´£æ‰€æœ‰å…ƒæ•°æ®çš„è¯»å†™å’Œä¸€è‡´æ€§ç»´æŠ¤ï¼ˆå¦‚ Topic åˆ›å»ºã€åˆ†åŒºæ‰©å®¹ã€å‰¯æœ¬åˆ†é…ï¼‰ã€‚
  - è´Ÿè´£ leader é€‰ä¸¾ã€é›†ç¾¤çŠ¶æ€ç›‘æŽ§ã€èŠ‚ç‚¹ä¸Šä¸‹çº¿æ£€æµ‹ã€‚
  - å”¯ä¸€èƒ½å†™å…¥å’Œæäº¤å…ƒæ•°æ®å˜æ›´çš„æ˜¯ Raft quorum çš„ Leaderã€‚
  - é€šè¿‡ Raft æ—¥å¿—å¤åˆ¶ä¿è¯æ‰€æœ‰ controller èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´ã€‚
 
#### 2.2 Brokerï¼ˆä»£ç†/æœåŠ¡ç«¯èŠ‚ç‚¹ï¼‰
- å®šä¹‰ï¼šBroker æ˜¯å®žé™…å­˜å‚¨å’Œè½¬å‘æ¶ˆæ¯çš„èŠ‚ç‚¹ã€‚
- èŒè´£ï¼š
  - å­˜å‚¨ç”¨æˆ·çš„æ¶ˆæ¯æ•°æ®ï¼ˆlog segmentï¼‰ã€‚
  - æ¯ä¸ª broker é€šè¿‡è®¢é˜… controller quorum çš„å…ƒæ•°æ®æ—¥å¿—ï¼Œä¿æŒè‡ªå·±çš„å…ƒæ•°æ®å‰¯æœ¬æœ€æ–°ã€‚
  - ä½œä¸ºåˆ†åŒºå‰¯æœ¬ï¼ˆleader æˆ– followerï¼‰å‚ä¸Žåˆ†åŒºå‰¯æœ¬åŒæ­¥ã€‚
  - Broker èŠ‚ç‚¹å¯ä»¥åŒæ—¶ä½œä¸º controller quorum çš„æˆå‘˜ï¼Œä¹Ÿå¯ä»¥åªä½œä¸ºæ™®é€šæ•°æ®èŠ‚ç‚¹ã€‚

#### 2.3 Partitionï¼ˆåˆ†åŒºï¼‰
- å®šä¹‰ï¼šæ¯ä¸ª topic è¢«åˆ’åˆ†ä¸ºè‹¥å¹² partitionï¼Œpartition æ˜¯ Kafka çš„å¹¶å‘å’Œé«˜å¯ç”¨å•ä½ã€‚
- èŒè´£ï¼š
  - æ¯ä¸ª partition æœ‰å¤šä¸ªå‰¯æœ¬ï¼ˆreplicaï¼‰ï¼Œåˆ†å¸ƒåœ¨ä¸åŒçš„ broker ä¸Šã€‚
  - åˆ†åŒºçš„ leader è´Ÿè´£å¤„ç† client çš„è¯»å†™è¯·æ±‚ï¼Œfollower è´Ÿè´£åŒæ­¥ leader çš„æ•°æ®ã€‚
  - partition çš„åˆ†é…ã€leader/follower çŠ¶æ€ç­‰å…ƒæ•°æ®ç”± controller ç®¡ç†å¹¶å¹¿æ’­ã€‚
 
### 3. å…ƒæ•°æ®çš„å¤„ç†æµç¨‹

#### 3.1 å…ƒæ•°æ®å†™å…¥æµç¨‹ï¼ˆå¦‚åˆ›å»º topicï¼‰
1. å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆå¦‚åˆ›å»º topicï¼‰å‘é€åˆ°ä»»ä¸€ controller quorum æˆå‘˜ã€‚
2. å¦‚æžœè¯¥èŠ‚ç‚¹ä¸æ˜¯ leaderï¼Œä¼šå°†è¯·æ±‚é‡å®šå‘åˆ° quorum leaderã€‚
3. Leader ç”Ÿæˆå…ƒæ•°æ®å˜æ›´æ—¥å¿—ï¼ˆå¦‚æ–° topicã€partitionã€replica assignmentï¼‰ã€‚
4. å…ƒæ•°æ®æ—¥å¿—é€šè¿‡ Raft å¤åˆ¶åˆ°æ‰€æœ‰ controller æˆå‘˜ï¼ˆå¤§å¤šæ•°æäº¤åŽç”Ÿæ•ˆï¼‰ã€‚
5. å¿—ï¼Œæ›´æ–°æœ¬åœ°å…ƒæ•°æ®ç¼“å­˜ã€‚
6. Broker æ ¹æ®æœ€æ–°å…ƒæ•°æ®è¿›è¡Œåˆ†åŒºåˆ›å»ºã€åˆ†é…å‰¯æœ¬ã€è°ƒæ•´ leader/follower ç­‰æ“ä½œã€‚

#### 3.2 å…ƒæ•°æ®è¯»å–æµç¨‹

- ä»»ä½• broker éƒ½å¯ä»¥ä¸º client æä¾›å…ƒæ•°æ®æŸ¥è¯¢æœåŠ¡ï¼ˆå¦‚ topic/partition åˆ—è¡¨ï¼‰ã€‚
- Broker æœ¬åœ°ç¼“å­˜çš„å…ƒæ•°æ®é€šè¿‡è®¢é˜… controller quorum çš„å…ƒæ•°æ®æ—¥å¿—å®šæœŸæ›´æ–°ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚

### 4. Controllerã€Brokerã€Partition çš„äº’åŠ¨

- Controller quorum ä½œä¸ºå”¯ä¸€çš„å…ƒæ•°æ®â€œæƒå¨â€ï¼Œæ‰€æœ‰å˜æ›´éƒ½å¿…é¡»é€šè¿‡å®ƒä»¬æäº¤ã€‚
- Broker ä»…ä½œä¸ºå…ƒæ•°æ®çš„â€œæ¶ˆè´¹è€…â€ä¸Žâ€œæ‰§è¡Œè€…â€ï¼Œä¸ä¼šä¸»åŠ¨ä¿®æ”¹å…ƒæ•°æ®ï¼Œåªèƒ½æ ¹æ® controller çš„æŒ‡ä»¤æ“ä½œå®žé™…åˆ†åŒºæˆ–å‰¯æœ¬ã€‚
- Partition çš„ leader/follower çŠ¶æ€ã€åˆ†å¸ƒã€ISRï¼ˆin-sync replicasï¼‰ç­‰éƒ½ç”± controller ç»Ÿä¸€è°ƒåº¦å’Œç»´æŠ¤ã€‚


## äºŒã€åˆ›å»ºtopicå…¨æµç¨‹

### 1. åˆ›å»º Topic è¯·æ±‚çš„æµè½¬

#### 1.1 Producer è¯·æ±‚åˆ° Controller éž Leader èŠ‚ç‚¹

- Producer æˆ–ç®¡ç†å‘˜å®¢æˆ·ç«¯ï¼ˆå¦‚ kafka-topics.shï¼‰å‘ä»»æ„ Controller èŠ‚ç‚¹å‘èµ·â€œåˆ›å»º topicâ€è¯·æ±‚ã€‚
- è¿™ä¸ª broker ä¼šæ£€æµ‹åˆ°è‡ªå·±ä¸æ˜¯å½“å‰çš„ Controller Leaderï¼Œç›´æŽ¥è¿”å›ž NOT_CONTROLLER é”™è¯¯ç»™å®¢æˆ·ç«¯ã€‚
- å®¢æˆ·ç«¯ï¼ˆå¦‚ kafka-topics.shã€AdminClientï¼‰æ”¶åˆ°è¿™ä¸ªé”™è¯¯åŽï¼Œä¼šè‡ªåŠ¨åˆ·æ–°å…ƒæ•°æ®ã€å‘çŽ°æ–°çš„ Controller Leaderï¼Œç„¶åŽåŽç»­çš„ç›¸å…³è¯·æ±‚ä¼šç›´æŽ¥å‘ç»™æ–°çš„ Controller Leaderã€‚
  
#### 1.2 Controller Leader å¤„ç†æµç¨‹
1. **ç”Ÿæˆå…ƒæ•°æ®å˜æ›´è®°å½•**
Controller leader å°†â€œåˆ›å»º topicâ€æ“ä½œå°è£…ä¸ºä¸€æ¡å…ƒæ•°æ®æ—¥å¿—ï¼ˆrecordï¼‰ï¼ŒåŒ…æ‹¬ topic åã€åˆ†åŒºæ•°ã€å‰¯æœ¬æ•°ç­‰

**åˆ†é…ç»“æžœæ•°æ®ç»“æž„ DEMO**
å‡è®¾æœ‰å¦‚ä¸‹åˆ›å»º topic è¯·æ±‚ï¼š

- topic: demo-topic
- partition æ•°: 3
- å‰¯æœ¬æ•°: 2
- é›†ç¾¤ broker: broker-1ï¼ˆnodeId=1ï¼‰, broker-2ï¼ˆnodeId=2ï¼‰, broker-3ï¼ˆnodeId=3ï¼‰
  
åˆ†é…ç»“æžœç¤ºä¾‹ï¼š
```json
{
  "topic": "demo-topic",
  "partitions": [
    {
      "partition": 0,
      "leader": 1,
      "replicas": [1, 2],
      "isr": [1, 2]
    },
    {
      "partition": 1,
      "leader": 2,
      "replicas": [2, 3],
      "isr": [2, 3]
    },
    {
      "partition": 2,
      "leader": 3,
      "replicas": [3, 1],
      "isr": [3, 1]
    }
  ]
}
```
- leaderï¼šè¯¥ partition çš„ leader brokerï¼ˆè´Ÿè´£è¯»å†™ï¼‰ã€‚
- replicasï¼šæ‰€æœ‰å‰¯æœ¬ brokerã€‚
- isrï¼šåˆå§‹æ—¶ç­‰äºŽ replicasï¼ˆéƒ½åœ¨åŒæ­¥çŠ¶æ€ï¼‰ã€‚

2. **KRaft æ¨¡å¼ä¸‹çš„åŒæ­¥æµç¨‹**
åœ¨ KRaftï¼ˆKafka Raftï¼‰æ¨¡å¼ä¸‹ï¼Œä¸å†ä¾èµ– ZooKeeperï¼ŒController è§’è‰²é€šè¿‡å†…ç½® Raft å…±è¯†æ—¥å¿—åŒæ­¥å…ƒæ•°æ®ï¼Œæµç¨‹å¦‚ä¸‹ï¼š
  - Controller é€‰ä¸¾ï¼šå…¨ä½“ broker é€‰å‡ºä¸€ä¸ª active controller
  - åˆ›å»º topic è¯·æ±‚åˆ°è¾¾ Controllerã€‚
  - Controller ç”Ÿæˆåˆ†é…æ–¹æ¡ˆï¼ˆç¤ºä¾‹å¦‚ä¸Šï¼‰ï¼Œå¹¶å°†æ“ä½œï¼ˆå¦‚ topic åˆ›å»ºã€åˆ†åŒºåˆ†é…ï¼‰å†™å…¥ KRaft å†…ç½®çš„å…ƒæ•°æ®æ—¥å¿—ï¼ˆ__cluster_metadata topicï¼‰ã€‚è¿™ä¸ªå†…ç½®çš„topicæ˜¯å•ä¸€partitionï¼›ä¹Ÿä¼šæœ‰ISR
  - Raft åè®®ä¿è¯è¯¥å…ƒæ•°æ®å˜æ›´åœ¨å¤§å¤šæ•° controller èŠ‚ç‚¹ä¸Šå¤åˆ¶å¹¶ commit
    - controllerèŠ‚ç‚¹æ•°å°äºŽç­‰äºŽbrokerèŠ‚ç‚¹æ•°
    - raftçš„commitæ˜¯éšå¼commitï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸¤é˜¶æ®µï¼š**åŒºåˆ«äºŽzab åŽŸå­å¹¿æ’­ï¼Œzabçš„ç¬¬äºŒé˜¶æ®µæ˜¯æ˜¾ç¤ºçš„å‘èµ·commitæ¶ˆæ¯ï¼ŒæŽ¨è¿›zxidï¼›è€Œraftæ˜¯éšå¼çš„åŒæ­¥commitIndexï¼Œå‡å°‘ç½‘ç»œå¼€é”€**
       - ç¬¬ä¸€é˜¶æ®µï¼š controller leaderåœ¨æœ¬åœ°å†™å…¥Raftæ—¥å¿—åŽï¼ˆpagecacheï¼‰ï¼Œå°†å…ƒæ•°æ®ä¸»åŠ¨æŽ¨ç»™controller followï¼Œå¾…æŽ¥æ”¶åˆ°è¶…è¿‡åŠæ•°followçš„ackåˆ™æŽ¨è¿›leader commitIndexï¼Œackç»™producer
       - ç¬¬äºŒé˜¶æ®µï¼šé€šè¿‡å¿ƒè·³æœºåˆ¶æˆ–appendEntryæ¶ˆæ¯å°†leaderæŽ¨è¿›çš„commitIndexåŒæ­¥è‡³controller followerï¼Œå½“ç„¶åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼šPull/applyäº¤äº’
         - Raft followerçš„åŒæ­¥ä¸€èˆ¬æ˜¯â€œè¢«åŠ¨æ‹‰+ä¸»åŠ¨æŽ¨â€ç»“åˆï¼š
           - æ­£å¸¸æƒ…å†µä¸‹Leaderä¸»åŠ¨æŽ¨é€æœ€æ–°æ¡ç›®ï¼ˆAppendEntries RPCï¼‰ã€‚
           - Followerå¦‚æžœæœ‰è½åŽï¼Œå¯ä»¥ä¸»åŠ¨pullï¼ˆé€šè¿‡RequestVote/InstallSnapshot/æ‹‰æ—¥å¿—ï¼‰ã€‚
         - Follower applyåŠ¨ä½œï¼š
           - FollowerèŠ‚ç‚¹ä¼šæŠŠcommitIndexä¹‹å‰çš„æ‰€æœ‰æ¡ç›®â€œapplyâ€åˆ°æœ¬åœ°çŠ¶æ€æœºï¼ˆå³æ›´æ–°è‡ªå·±çš„å…ƒæ•°æ®å¿«ç…§ï¼‰ã€‚
           - è¿™æ ·æ‰€æœ‰controllerèŠ‚ç‚¹çš„çŠ¶æ€éƒ½æ˜¯ä¸€è‡´çš„ã€‚
    
  - Kafka åˆ›å»º topic çš„ ack è¿”å›žæ–¹å¼
    - å½“å…ƒæ•°æ®å†™å…¥ KRaft æ—¥å¿—å¹¶ commitï¼Œä¸” controller åšå®Œåˆ†é…åŽï¼Œæ‰å‘è¯·æ±‚ client è¿”å›žâ€œæˆåŠŸâ€ackã€‚
    - åªæœ‰æ­¤æ—¶ï¼Œæ‰€æœ‰ broker éƒ½å¯æ„ŸçŸ¥åˆ°æ–° topic/partition/leader çš„ä¿¡æ¯ï¼ŒProducer æ‰èƒ½ç»§ç»­åŽç»­ç”Ÿäº§æ¶ˆæ¯ã€‚
    - è‹¥ commit å¤±è´¥/è¶…æ—¶ï¼Œåˆ™ client æ”¶åˆ°å¼‚å¸¸ï¼ˆå¦‚ NOT_CONTROLLERã€TIMEOUT ç­‰ï¼‰ã€‚
    
3. **è¿”å›ž Producer**
leader commit åŽï¼Œå³å¯å‘ producer/client è¿”å›žâ€œåˆ›å»ºæˆåŠŸâ€å“åº”ã€‚

### 2. Partition åˆ†é…å’Œå‰¯æœ¬åˆ†å¸ƒ

#### 2.1 åˆ†åŒºåˆ†é…ç­–ç•¥

- Controller leader æ ¹æ® topic çš„åˆ†åŒºæ•°å’Œå‰¯æœ¬å› å­ï¼Œä¸ºæ¯ä¸ª partition æŒ‘é€‰ä¸€ç»„ broker ä½œä¸ºå‰¯æœ¬èŠ‚ç‚¹ã€‚
- é»˜è®¤é‡‡ç”¨â€œè½®è¯¢+å‡è¡¡â€çš„åˆ†å¸ƒå¼åˆ†é…ç®—æ³•ï¼ˆRound Robinã€Rack Awarenessç­‰ï¼‰ï¼Œé¿å…çƒ­ç‚¹å’Œå•ç‚¹ã€‚
  
ä¾‹å¦‚ï¼š

- åˆ›å»º topic fooï¼Œ3 åˆ†åŒºï¼Œ2 å‰¯æœ¬ï¼Œé›†ç¾¤æœ‰ broker 1/2/3ã€‚
- å¯èƒ½çš„åˆ†é…ç»“æžœï¼š
  - partition 0: broker 1, broker 2
  - partition 1: broker 2, broker 3
  - partition 2: broker 3, broker 1
    
#### 2.2 Partition Leader é€‰æ‹©

- é»˜è®¤æ¯ä¸ª partition çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬èŠ‚ç‚¹ä¸º leaderã€‚
- controller leader åœ¨åˆ†é…æ—¶æŒ‡å®šæ¯ä¸ª partition çš„ leaderï¼ˆé€šå¸¸æ˜¯è¯¥ partition çš„å‰¯æœ¬åˆ—è¡¨ç¬¬ä¸€ä¸ª brokerï¼‰ã€‚

### 3. Partition å‰¯æœ¬åŒæ­¥æœºåˆ¶

#### 3.1 å…ƒæ•°æ®ä¸‹å‘

- æ‰€æœ‰ broker ç›‘å¬ controller quorum çš„å…ƒæ•°æ®æ—¥å¿—æ›´æ–°ã€‚
- ä¸€æ—¦ topic åˆ›å»ºå¹¶ commitï¼Œæ‰€æœ‰ broker ä¼šæ”¶åˆ°æœ€æ–°çš„ topic/partition/replica åˆ†é…ä¿¡æ¯ã€‚
  
#### 3.2 å‰¯æœ¬åˆ›å»ºä¸Žåˆ†åŒºæœ¬åœ°åˆå§‹åŒ–

- è¢«æŒ‡å®šä¸ºæŸ partition å‰¯æœ¬çš„ brokerï¼Œä¼šåœ¨æœ¬åœ°åˆå§‹åŒ–å¯¹åº”çš„ log ç›®å½•å’Œå…ƒæ•°æ®ã€‚
- partition leader broker ä¼šæˆä¸ºè¯¥åˆ†åŒºçš„â€œä¸»â€ï¼ŒæŽ¥æ”¶ client çš„ produce/consume è¯·æ±‚ã€‚
  
#### 3.3 å‰¯æœ¬åŒæ­¥æµç¨‹

- partition leader è´Ÿè´£åŒæ­¥æ•°æ®åˆ° follower å‰¯æœ¬ã€‚
- follower é€šè¿‡ Fetch è¯·æ±‚ä»Ž leader æ‹‰å–æ•°æ®ã€‚
- Kafka é€šè¿‡ ISRï¼ˆIn-Sync Replicasï¼‰æœºåˆ¶ï¼Œç›‘æŽ§å„å‰¯æœ¬åŒæ­¥è¿›åº¦ã€‚
- åªæœ‰ ISR å†…çš„å‰¯æœ¬æ‰è¢«è®¤ä¸ºâ€œæ´»è·ƒâ€ï¼Œå†™å…¥æˆåŠŸå¿…é¡»è¢«æ‰€æœ‰ ISR å‰¯æœ¬ç¡®è®¤ã€‚

```bash
Producer -> ä»»æ„ Controller -> Controller Leader
    |        (è½¬å‘/é‡å®šå‘)         |
    |---------------------------->| åˆ›å»º topic request
    |<- è¿”å›žæˆåŠŸå“åº”ï¼ˆcommitåŽï¼‰   |
    |
Controller Leader:
    - ç”Ÿæˆå…ƒæ•°æ®å˜æ›´ï¼ˆåˆ†åŒº/å‰¯æœ¬åˆ†é…ï¼‰
    - Raft æ—¥å¿—å¤åˆ¶å¹¶ commit
    - æœ¬åœ°å…ƒæ•°æ® apply
    - å‘æ‰€æœ‰ broker å¹¿æ’­æœ€æ–° metadata

Broker:
    - æ”¶åˆ°æ–° topic/partition åˆ†é…
    - å„è‡ªåˆå§‹åŒ– partition å‰¯æœ¬
    - leader broker è´Ÿè´£å†™å…¥/åŒæ­¥
    - follower broker é€šè¿‡ Fetch æ‹‰å–
    - ISR æœºåˆ¶ä¿è¯å‰¯æœ¬å¼ºä¸€è‡´
```


é—®é¢˜1:
å‰¯æœ¬brokerä¹ŸåŒ…å«leaderèŠ‚ç‚¹æ˜¯ä¹ˆï¼Ÿè¿™æ¡å…ƒæ•°æ®ä¹Ÿä¼šæ›´æ–°è‡³pagecacheä¹ˆï¼Ÿ

æ˜¯çš„ï¼Œpartitionçš„leaderå…¶å®žä¹Ÿæ˜¯å‰¯æœ¬(replica)çš„ä¸€ç§ï¼Œåªä¸è¿‡æ˜¯ISRä¸­çš„é‚£ä¸ªâ€œä¸»â€å‰¯æœ¬ã€‚
æ¯”å¦‚ Partition-0 å‰¯æœ¬åˆ†å¸ƒæ˜¯[broker-1, broker-2, broker-3]ï¼Œå…¶ä¸­ broker-2 æ—¢æ˜¯å‰¯æœ¬ä¹Ÿæ˜¯leaderã€‚
Kafkaæ‰€æœ‰brokerï¼ˆæ— è®ºæ˜¯leaderè¿˜æ˜¯followerï¼‰éƒ½ç»´æŠ¤partitionå…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ¯ä¸ªpartitionçš„leaderæ˜¯è°ã€ISRæœ‰å“ªäº›ã€‚
è¿™äº›å…ƒæ•°æ®ä¼šè¢«åŠ è½½åˆ°å†…å­˜ï¼ˆé€šå¸¸è¿˜æœ‰pagecacheï¼‰ï¼Œä»¥ä¾¿å¿«é€Ÿè·¯ç”±å’Œç®¡ç†ã€‚
ç”Ÿäº§çŽ¯å¢ƒä¸‹å…ƒæ•°æ®å˜æ›´éžå¸¸å¿«ï¼Œä½†æ•°æ®é‡è¾ƒå°ï¼Œé€šå¸¸éƒ½åœ¨å†…å­˜å’Œpagecacheä¸­æœ‰ç¼“å­˜ã€‚



é—®é¢˜2:
  å…ƒæ•°æ®æ—¥å¿—ä¹Ÿæ˜¯ä¸€ä¸ªå†…éƒ¨çš„topicï¼ŒæŒä¹…åŒ–æ“ä½œå’Œæ­£å¸¸æ¶ˆæ¯ä¸€æ ·ï¼Ÿæœ‰partitionå’ŒISRå—ï¼Ÿ

  KRaftæ¨¡å¼ä¸‹çš„å…ƒæ•°æ®æ—¥å¿—ç¡®å®žæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å†…éƒ¨topicï¼Œå«__cluster_metadataã€‚
è¿™ä¸ªtopicè®°å½•äº†é›†ç¾¤çš„æ‰€æœ‰å…ƒæ•°æ®å˜æ›´ï¼ˆå¦‚topicåˆ›å»ºã€åˆ†åŒºåˆ†é…ã€ACLä¿®æ”¹ç­‰ï¼‰ã€‚
è¿™ä¸ªå†…éƒ¨topicåªä¼šæœ‰ä¸€ä¸ªpartitionï¼ˆå•åˆ†åŒºï¼‰ï¼Œå› ä¸ºRaftåè®®è¦æ±‚å…¨åºã€‚
å®ƒä¹Ÿæœ‰ISRæœºåˆ¶ï¼š
Raftç®¡ç†çš„controllerèŠ‚ç‚¹ï¼ˆé€šå¸¸æ˜¯ä¸€ç»„brokerï¼‰éƒ½ç»´æŠ¤è¯¥partitionçš„å‰¯æœ¬ã€‚
åªæœ‰ISRå†…çš„èŠ‚ç‚¹ï¼ˆå³Raft quorumä¸­çš„followerï¼‰æ‰èƒ½å‚ä¸Žcommitã€‚
æŒä¹…åŒ–æ–¹å¼å’Œæ™®é€šæ¶ˆæ¯ç±»ä¼¼ï¼ˆé¡ºåºå†™å…¥log segmentï¼‰ï¼Œä½†åè®®å’Œä¸€è‡´æ€§ä¿è¯æ›´ä¸¥æ ¼ï¼Œcommitä¾èµ–Raftæ—¥å¿—å¤åˆ¶ä¸Žæäº¤ã€‚

é—®é¢˜3:
KRaftçš„commitæœºåˆ¶ï¼šcommitIndexåŒæ­¥ä¸Žéšå¼æäº¤

KRaftï¼ˆRaftåè®®ï¼‰é‡Œçš„commitåŠ¨ä½œæ˜¯éšå¼çš„ï¼Œä¸éœ€è¦æ˜¾å¼â€œcommitâ€å‘½ä»¤ã€‚
Controller LeaderæŽ¥æ”¶åˆ°å¦‚â€œåˆ›å»ºtopicâ€ç­‰å˜æ›´è¯·æ±‚åŽï¼Œå°†æ—¥å¿—æ¡ç›®ï¼ˆå¦‚topicåˆ›å»ºå…ƒæ•°æ®ï¼‰å†™å…¥è‡ªèº«çš„Raftæ—¥å¿—ã€‚
ç„¶åŽåŒæ­¥ç»™å…¶ä»–controllerèŠ‚ç‚¹ï¼ˆRaft followerï¼‰ã€‚
ä¸€æ—¦æœ‰è¶…è¿‡åŠæ•°followerå‰¯æœ¬ackè¯¥æ—¥å¿—æ¡ç›®ï¼Œcontroller leaderå°±å°†è¯¥æ¡ç›®çš„commitIndexå‘å‰æŽ¨è¿›ï¼Œå¹¶è®¤ä¸ºè¯¥æ“ä½œå·²è¢«é›†ç¾¤å¤§å¤šæ•°èŠ‚ç‚¹æŒä¹…åŒ–ã€‚
æ–°çš„åˆ›å»ºtopicæˆ–å¿ƒè·³ï¼ˆAppendEntriesï¼‰ä¼šå¸¦ä¸Šæœ€æ–°çš„commitIndexï¼Œfolloweræ®æ­¤applyåˆ°æœ¬åœ°çŠ¶æ€æœºã€‚
è¿™æ­£æ˜¯Raftçš„æ ¸å¿ƒä¸€è‡´æ€§ä¿éšœæœºåˆ¶ã€‚

é—®é¢˜4:
controllerèŠ‚ç‚¹å…ƒæ•°æ®åŒæ­¥ã€commitIndexç®¡ç†åŠpull/applyæµç¨‹

4.1 å…ƒæ•°æ®åŒæ­¥æµç¨‹
Controller Leaderåœ¨æœ¬åœ°å†™å…¥Raftæ—¥å¿—åŽï¼Œä¸»åŠ¨å°†æ—¥å¿—æ¡ç›®ï¼ˆå…ƒæ•°æ®å˜æ›´ï¼‰â€œAppendEntriesâ€æŽ¨é€ç»™followerï¼ˆå³å…¶å®ƒcontrollerèŠ‚ç‚¹ï¼‰ã€‚
Followeræ”¶åˆ°åŽå†™å…¥æœ¬åœ°Raftæ—¥å¿—ï¼Œå¹¶ackç»™Leaderã€‚
Leaderæ”¶åˆ°è¶…è¿‡åŠæ•°controllerèŠ‚ç‚¹ackåŽï¼Œå°†è¯¥æ¡ç›®æ ‡è®°ä¸ºcommitï¼ˆæŽ¨è¿›commitIndexï¼‰ã€‚
4.2 Pull/applyäº¤äº’
Raft followerçš„åŒæ­¥ä¸€èˆ¬æ˜¯â€œè¢«åŠ¨æ‹‰+ä¸»åŠ¨æŽ¨â€ç»“åˆï¼š
æ­£å¸¸æƒ…å†µä¸‹Leaderä¸»åŠ¨æŽ¨é€æœ€æ–°æ¡ç›®ï¼ˆAppendEntries RPCï¼‰ã€‚
Followerå¦‚æžœæœ‰è½åŽï¼Œå¯ä»¥ä¸»åŠ¨pullï¼ˆé€šè¿‡RequestVote/InstallSnapshot/æ‹‰æ—¥å¿—ï¼‰ã€‚
Follower applyåŠ¨ä½œï¼š
FollowerèŠ‚ç‚¹ä¼šæŠŠcommitIndexä¹‹å‰çš„æ‰€æœ‰æ¡ç›®â€œapplyâ€åˆ°æœ¬åœ°çŠ¶æ€æœºï¼ˆå³æ›´æ–°è‡ªå·±çš„å…ƒæ•°æ®å¿«ç…§ï¼‰ã€‚
è¿™æ ·æ‰€æœ‰controllerèŠ‚ç‚¹çš„çŠ¶æ€éƒ½æ˜¯ä¸€è‡´çš„ã€‚
4.3 ackæ—¶æœº
åªæœ‰å½“å¤§å¤šæ•°controllerèŠ‚ç‚¹ï¼ˆRaft quorumï¼‰åŒæ­¥å¹¶commitäº†è¯¥å…ƒæ•°æ®å˜æ›´ï¼ŒLeaderæ‰ä¼šè¿”å›žackç»™Producer/AdminClientã€‚
ç¡®ä¿â€œåˆ›å»ºtopicâ€è¿™ç§æ“ä½œä¸ä¼šå› å•ç‚¹æ•…éšœå¯¼è‡´è„‘è£‚ã€‚
4.4 æ‰€æœ‰brokerçš„å…ƒæ•°æ®åŒæ­¥ï¼Ÿ
åªæœ‰Controlleré›†ç¾¤ï¼ˆé€šå¸¸3/5ä¸ªbrokerï¼‰éœ€è¦å¼ºä¸€è‡´commitã€‚
æ‰€æœ‰brokerï¼ˆä¸åªæ˜¯controllerï¼‰éƒ½ä¼šâ€œè®¢é˜…â€å…ƒæ•°æ®æ—¥å¿—ï¼Œæ‹¿åˆ°æœ€æ–°çš„å…ƒæ•°æ®è§†å›¾ç”¨äºŽè‡ªèº«æ•°æ®è°ƒåº¦å’ŒæœåŠ¡Producer/Consumerè¯·æ±‚ã€‚
ä½†åªè¦Controllerçš„Raft quorumâ€œå·²commitâ€ï¼Œå°±å¯ä»¥è®¤ä¸ºå˜æ›´å·²ç”Ÿæ•ˆå¹¶ackå®¢æˆ·ç«¯ã€‚
æ™®é€šbrokerçš„åŒæ­¥æ˜¯æœ€ç»ˆä¸€è‡´ï¼Œä¸å½±å“åˆ›å»ºtopicç­‰æ“ä½œçš„æäº¤ã€‚


é—®é¢˜5:
â€œè¶…è¿‡åŠæ•°â€æ˜¯æŒ‡Raft ControllerèŠ‚ç‚¹çš„å¤šæ•°ï¼Œè€Œä¸æ˜¯ISRä¸­æ‰€æœ‰follower

åœ¨KRaftï¼ˆRaftåè®®ï¼‰ä¸‹ï¼Œcommitçš„åˆ¤å®šæ ‡å‡†æ˜¯è¶…è¿‡åŠæ•°ï¼ˆmajority/quorumï¼‰controllerèŠ‚ç‚¹å·²ç»å†™å…¥äº†æ—¥å¿—æ¡ç›®ï¼ˆå³ackäº†æ—¥å¿—ï¼‰ã€‚
å‡å¦‚æœ‰Nä¸ªcontrollerèŠ‚ç‚¹ï¼Œåªè¦æœ‰ âŒŠN/2âŒ‹+1 ä¸ªèŠ‚ç‚¹æŒä¹…åŒ–è¯¥æ¡ç›®ï¼Œå³å¯æŽ¨è¿›commitIndexã€‚
è¿™ä¸Žâ€œISRçš„æ‰€æœ‰followerâ€ä¸æ˜¯ä¸€å›žäº‹ã€‚ISRï¼ˆIn-Sync Replicasï¼‰æ˜¯é’ˆå¯¹partitionæ•°æ®å‰¯æœ¬åŒæ­¥ï¼ŒRaft Quorumæ˜¯é’ˆå¯¹å…ƒæ•°æ®æ—¥å¿—çš„å…±è¯†ã€‚
ä¸¾ä¾‹ï¼š5ä¸ªcontrollerèŠ‚ç‚¹ï¼Œ3ä¸ªèŠ‚ç‚¹å†™å…¥å³ç®—commitï¼Œå“ªæ€•æœ‰2ä¸ªè½åŽä¹Ÿä¸å½±å“â€œå·²commitâ€çŠ¶æ€ã€‚


é—®é¢˜6:
ä¸Žzabæ˜¯ä¸æ˜¯ä¸€æ ·ï¼Œåªè¦è¶…è¿‡åŠæ•°èŠ‚ç‚¹æŒä¹…åŒ–äº†ï¼Œå“ªæ€•æ­¤æ—¶leader downæœºï¼Œleaderæœªæ”¶åˆ°è¶…åŠæ•°follow ackï¼Œæœªackç»™producerï¼ŒæœªæŽ¨è¿›commitIndexï¼Œæœªé€šè¿‡å¿ƒè·³åŒæ­¥commitIndexè‡³followï¼Œè¿™æ¡æ•°æ®éƒ½ä¸ä¼šä¸¢å¤±

é—®é¢˜7:
controller/followerçš„ä¸¤é˜¶æ®µä¸Žæ™®é€šbrokerçš„åŒæ­¥æœºåˆ¶

æ™®é€šbrokerèŠ‚ç‚¹ï¼ˆéžcontrollerï¼‰çš„æ•°æ®èŽ·å–ä¸ŽåŒæ­¥

è¢«åŠ¨æŽ¥æ”¶ï¼š controller-leaderä¼šä¸»åŠ¨æŽ¨é€æœ€æ–°çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ˆå¦‚PartitionMetadataã€TopicMetadataç­‰ï¼‰ç»™æ‰€æœ‰brokerã€‚
å¯åŠ¨æ—¶/é‡è¿žæ—¶ï¼š brokerèŠ‚ç‚¹å¯åŠ¨æˆ–ä¸Žcontrolleré‡è¿žåŽï¼Œä¼šä¸»åŠ¨æ‹‰å–ä¸€ä»½å®Œæ•´çš„å…ƒæ•°æ®å¿«ç…§ã€‚
æ—¥å¸¸è¿è¡Œæ—¶ï¼š brokeræ”¶åˆ°controlleræŽ¨é€çš„å…ƒæ•°æ®å¢žé‡æ›´æ–°ã€‚
brokerä¹‹é—´ä¸ä¼šäº’ç›¸åŒæ­¥å…ƒæ•°æ®ï¼Œåªå’Œcontrolleré€šä¿¡ã€‚

æ™®é€šbrokeråªä¼šè¢«åŠ¨æŽ¥æ”¶controller leaderæŽ¨é€çš„å…ƒæ•°æ®æ¶ˆæ¯ã€‚
è¿™äº›æŽ¨é€æ˜¯controller leaderåœ¨raft commitå®ŒæˆåŽé¢å¤–æž„é€ å¹¶å‘é€çš„ä¸“é—¨æ¶ˆæ¯ï¼Œä¸æ˜¯raftæ—¥å¿—åŒæ­¥è¿‡ç¨‹çš„â€œå‰¯äº§å“â€ã€‚
æ™®é€šbrokerå®Œå…¨ä¸å‚ä¸Žcontrolleré›†ç¾¤çš„raftæ—¥å¿—åŒæ­¥è¿‡ç¨‹ã€‚

æ¶ˆæ¯æµè½¬è·¯çº¿
controller leaderå†™å…¥raftæ—¥å¿— â†’ raft commit â†’ controller leaderåº”ç”¨å˜æ›´ â†’ ä¸»åŠ¨æŽ¨é€å…ƒæ•°æ®åˆ°æ‰€æœ‰brokerï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰

é—®é¢˜8:
produceråˆ›å»ºå®Œtopicï¼Œæ”¶åˆ°controller leader ackåŽï¼Œè¯·æ±‚ä»»æ„brokerèŽ·å–topicå…ƒæ•°æ®æ—¶ï¼Œèƒ½å¦æ‹¿åˆ°æœ€æ–°å…ƒæ•°æ®ï¼Ÿ

æ­£å¸¸æƒ…å†µä¸‹ï¼š å‘ä»»æ„brokerè¯·æ±‚topicå…ƒæ•°æ®æ—¶ï¼Œbrokerä¼šè¿”å›žå®ƒæœ¬åœ°å·²çŸ¥çš„æœ€æ–°å…ƒæ•°æ®ã€‚

æžç«¯æƒ…å†µä¸‹ï¼š

ç”±äºŽå…ƒæ•°æ®æ˜¯controlleræŽ¨é€åˆ°brokerï¼Œå­˜åœ¨ç½‘ç»œå»¶è¿Ÿæˆ–è€…æŽ¨é€å°šæœªå®Œæˆçš„æƒ…å†µã€‚
è¿™æ„å‘³ç€ï¼šè¯·æ±‚åˆ°çš„brokerå¯èƒ½è¿˜æ²¡æ”¶åˆ°æœ€æ–°çš„å…ƒæ•°æ®ï¼Œè¿”å›žçš„å¯èƒ½æ˜¯â€œæ—§æ•°æ®â€ã€‚
è¿™ç§æƒ…å†µåœ¨åˆšåˆ›å»ºtopicã€åˆšå˜æ›´åˆ†åŒºã€åˆšè¿ç§»leaderç­‰æ“ä½œåŽæ›´å®¹æ˜“å‘ç”Ÿã€‚
KRaftä¸‹çš„è®¾è®¡åˆè¡·ï¼š

controlleræŽ¨é€æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ä¿è¯æ‰€æœ‰brokerå…ƒæ•°æ®æ€»æ˜¯100%ä¸€è‡´ã€‚
å®¢æˆ·ç«¯SDKé€šå¸¸ä¼šè‡ªåŠ¨é‡è¯•/åˆ·æ–°å…ƒæ•°æ®ï¼Œæˆ–è€…å½“å‘çŽ°topicä¸å­˜åœ¨åŽé‡æ–°è¯·æ±‚metadataã€‚
Kafkaå®˜æ–¹æ–‡æ¡£æ˜Žç¡®æåˆ°ï¼Œå…ƒæ•°æ®ä¸€è‡´æ€§æ˜¯â€œæœ€ç»ˆä¸€è‡´æ€§â€ï¼Œè€Œä¸æ˜¯å¼ºä¸€è‡´æ€§ã€‚
åœ¨æžç«¯æƒ…å†µä¸‹ï¼ˆæ¯”å¦‚æ–°topicåˆšåˆ›å»ºï¼‰ï¼Œéƒ¨åˆ†brokerçŸ­æ—¶é—´å†…å¯èƒ½æŸ¥ä¸åˆ°topicå…ƒæ•°æ®ã€‚
